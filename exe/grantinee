#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require 'optparse'
require 'grantinee'

Grantinee.detect_active_record_connection!

# NOTE: we expect a Grantinee file of permissions by default
file_name = "Grantinee"

# Parse command line arguments
parser = OptionParser.new do |opts|
  opts.banner = 'Usage: grantinee [options]'

  # Help
  opts.on('-h', '--help', 'Displays help') do
    puts opts
    exit
  end

  # Verbose mode
  opts.on('-v', '--verbose', 'Run verbosely') do |_n|
    Grantinee.configuration.verbose = true
  end

  # Database configuration file
  opts.on('-cFILE', '--config=FILE', 'Database configuration file path') do |file_path|
    require 'yaml'
    config_yaml = YAML.safe_load(File.read(file_path))

    Grantinee.configure do |c|
      config_yaml.each do |key, value|
        if Grantinee::Configuration::SUPPORTED_ARGUMENTS.include?(key.to_s)
          c.send(:"#{key}=", value)
        else
          puts "Warning: Unsupported configuration argument '#{key}'"
        end
      end
    end
  end

  opts.on("-f", "--permissions=FILE", "File path of the defined permissions") do |file_path|
    file_name = file_path
  end
end

parser.parse!

# Read the DSL commands and prepare the engine
parser = Grantinee::Dsl.eval(File.read(file_name))
engine = Grantinee::Engine.for Grantinee.configuration.engine

# Revoke permissions
parser.permissions.each { |data| engine.revoke_permissions!(data) }

# Grant permissions
parser.permissions.each { |data| engine.grant_permission!(data) }
